---
title: "data_generation"
author: "Jack Thomas"
date: "5/9/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Data generation for Blanc et al. model.

```{r define}
# number of sites
nsites <- 16

# number of individuals in capture history
n <- 10

# number of sampling occasions in capture-recapture
nsample_cap <- 5

# number of sampling occasions in presence-absence
nsample_pa <- 7

# capture probability
p <- 0.5

# occupancy probability
occupancy <- 0.3

# amount of movement for the species
tau <- 0.1
```


# Simulate Individuals

```{r individuals}
set.seed(1313)
# our study area is the unit square

# define homerange centers

# Poisson process, with x, y coordinates as independent uniform
# random variables

homeranges <- array(data = NA, dim = c(n, 2), dimnames = list(c(1:n), c("x", "y")))

for (i in 1:n) {
  x <- runif(1)
  y <- runif(1)
  homeranges[i, 1] <- x
  homeranges[i, 2] <- y
}

# plotting homeranges for validation
par(pty = "s")
plot(homeranges, xlim = c(0, 1), ylim = c(0, 1))
```

# Presence-Absence Data

```{r presence-absence area}
# We now have a m x m grid for the unit square as our divided area

# number of grid cells per row
m <- sqrt(nsites)

# x coordinates
regions_x <- array(data = NA, dim = c(m * m, 2))

for (k in 0:m - 1) {
  for (i in 1:m) {
    regions_x[i + k * m, 1] <- (i - 1) / m
    regions_x[i + k * m, 2] <- regions_x[i + k * m, 1] + 1 / m
  }
}

# y coordinates
regions_y <- array(data = NA, dim = c(m * m, 2))
j <- 0
for (i in 1:(m * m)) {
  regions_y[i, 1] <- j
  regions_y[i, 2] <- j + 1 / m

  if (i %% m == 0) {
    j <- j + 1 / m
  }
}

# regions are in x0,x1,y0,y1 form
regions <- cbind(regions_x, regions_y)

# plot grid cells on study area with homerange centers
par(pty = "s")
plot(homeranges, xlim = c(0, 1), ylim = c(0, 1))
for (i in 0:m) {
  abline(v = i / m)
  abline(h = i / m)
}
```

```{r pa-data}
library(OpenMx)
options(scipen=999)

# simulate presence-absence data for each region for each period nsample_occ

# 2D matrix with rows being regions and columns being time periods
presence_absence <- array(data = 0, dim = c(m * m, nsample_pa))


#' Calculate Proportion of Time Spent in Grid Cell
#'
#' @param x The x coordinate of the homerange for an individual
#' @param y The y coordinate of the homerange for an individual
#' @param x0 The starting x value for the grid cell
#' @param x1 The ending x value for the grid cell
#' @param y0 The starting y value for the grid cell
#' @param y1 The ending y value for the grid cell
#' @param tau The movement parameter for the species, lower is less movement
#'
#' @return A value between 0 and 1 indicating the proportion of time that the
#'         individual spends in the given grid cell
#' @export
#'
#' @examples
#' # show high proportion when homerange in center of grid cell
#' calc_prop(0.25 / 2, 0.25 / 2, 0, 0.25, 0, 0.25, 0.1)
calc_prop <- function(x, y, x0, x1, y0, y1, tau) {
  covariance <- matrix(c(tau^2, 0, 0, tau^2), nrow = 2, ncol = 2)
  means <- c(x, y)
  lbound <- c(x0, y0)
  ubound <- c(x1, y1)

  prop <- omxMnor(covariance, means, lbound, ubound)[1]
  return(prop)
}


# for each region
indi_props <- array(data = NA, dim = c(nrow(regions),nrow(homeranges)))
for (i in 1:nrow(regions)) {
  # compute proportion of time each individual spends in this region
  for (j in 1:nrow(homeranges)) {
    x <- homeranges[j, 1]
    y <- homeranges[j, 2]

    x0 <- regions[i, 1]
    x1 <- regions[i, 2]

    y0 <- regions[i, 3]
    y1 <- regions[i, 4]

    prop <- calc_prop(x, y, x0, x1, y0, y1, tau)
    indi_props[i,j] <- prop
  }
}
#     compute probability of detection for each individual
#     for each period k
#         run the r.v generation and say whether each individual was detected
#         if we have at least one detection, this region had a presence 1 in period k
```
